"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const cdk = require("@aws-cdk/core");
const iam = require("@aws-cdk/aws-iam");
const sfn = require("@aws-cdk/aws-stepfunctions");
const lambda = require("@aws-cdk/aws-lambda");
const sfn_tasks = require("@aws-cdk/aws-stepfunctions-tasks");
class PersonalizeManagementStack extends cdk.Stack {
    constructor(scope, id, props = {}) {
        super(scope, id, props);
        const lambdaFn = new lambda.Function(this, 'PersonalizeAPIExecutor', {
            code: new lambda.AssetCode('resource/lambda'),
            handler: 'action-executor.handler',
            runtime: lambda.Runtime.NODEJS_10_X,
        });
        if (lambdaFn.role) { // This weirdness is to get around TypeScript 'undefined' rules
            lambdaFn.role.addManagedPolicy(iam.ManagedPolicy.fromAwsManagedPolicyName('service-role/AmazonPersonalizeFullAccess'));
            lambdaFn.role.addManagedPolicy(iam.ManagedPolicy.fromAwsManagedPolicyName('CloudWatchFullAccess'));
        }
        const createDatasetGroup = new sfn.Task(this, 'Create Dataset Group', {
            task: new sfn_tasks.InvokeFunction(lambdaFn)
        });
        const describeDatasetGroupStatus = new sfn.Task(this, 'Describe Dataset Group', {
            task: new sfn_tasks.InvokeFunction(lambdaFn),
            outputPath: "$.datasetGroup"
        });
        const createDataset = new sfn.Task(this, 'Create Dataset', {
            task: new sfn_tasks.InvokeFunction(lambdaFn)
        });
        const describeDatasetStatus = new sfn.Task(this, 'Describe Dataset', {
            task: new sfn_tasks.InvokeFunction(lambdaFn),
            outputPath: "$.dataset"
        });
        const describeDatasetImportJob = new sfn.Task(this, 'Describe Dataset Import Job', {
            task: new sfn_tasks.InvokeFunction(lambdaFn),
            outputPath: "$.datasetImportJob"
        });
        const createDatasetImportJob = new sfn.Task(this, 'Create Dataset Import Job', {
            task: new sfn_tasks.InvokeFunction(lambdaFn),
        });
        const createSchema = new sfn.Task(this, 'Create Schema', {
            task: new sfn_tasks.InvokeFunction(lambdaFn)
        });
        const setCreateDatasetGroup = new sfn.Pass(this, 'Set Create Dataset Group', {
            parameters: { verb: "createDatasetGroup", params: { "name.$": "$.name" } },
            resultPath: "$.action"
        });
        const setCreateDataset = new sfn.Pass(this, 'Set Create Dataset', {
            parameters: {
                verb: "createDataset",
                params: {
                    "datasetGroupArn.$": "$.datasetGroupArn",
                    "datasetType.$": "$.datasetType",
                    "name.$": "$.name",
                    "schemaArn.$": "$.schemaArn"
                }
            },
            resultPath: "$.action"
        });
        const setCreateDatasetImportJob = new sfn.Pass(this, 'Set Create Dataset Import Job', {
            parameters: {
                verb: "createDatasetImportJob",
                params: {
                    "dataSource.$": "$.dataSource",
                    "datasetArn.$": "$.datasetArn",
                    "jobName.$": "$.jobName",
                    "roleArn.$": "$.roleArn"
                }
            },
            resultPath: "$.action"
        });
        const setDescribeDataset = new sfn.Pass(this, 'Set Describe Dataset', {
            parameters: { verb: "describeDataset", params: { "datasetArn.$": "$.datasetArn" } },
            resultPath: "$.action"
        });
        const setDescribeDatasetImportJob = new sfn.Pass(this, 'Set Describe Dataset Import Job', {
            parameters: { verb: "describeDatasetImportJob", params: { "datasetImportJobArn.$": "$.datasetImportJobArn" } },
            resultPath: "$.action"
        });
        const setDescribeDatasetGroup = new sfn.Pass(this, 'Set Describe Dataset Group', {
            parameters: { verb: "describeDatasetGroup", params: { "datasetGroupArn.$": "$.datasetGroupArn" } },
            resultPath: "$.action"
        });
        const setCreateSchema = new sfn.Pass(this, 'Set Create Schema', {
            parameters: { verb: "createSchema", params: { "name.$": "$.name", "schema.$": "$.schema" } },
            resultPath: "$.action"
        });
        const wait5Seconds = new sfn.Wait(this, 'Wait 5 Seconds', {
            time: sfn.WaitTime.duration(cdk.Duration.seconds(5))
        });
        const wait30Seconds = new sfn.Wait(this, 'Wait 30 Seconds', {
            time: sfn.WaitTime.duration(cdk.Duration.seconds(30))
        });
        // TODO: Add 'Catch' to states to capture execution errors as per this blog:
        // https://theburningmonk.com/2017/07/applying-the-saga-pattern-with-aws-lambda-and-step-functions/
        const fail = new sfn.Fail(this, 'Create Failed');
        const success = new sfn.Succeed(this, 'Success');
        const isComplete = new sfn.Choice(this, 'Create Complete?');
        const dsgChain = sfn.Chain
            .start(setCreateDatasetGroup)
            .next(createDatasetGroup)
            .next(setDescribeDatasetGroup)
            .next(wait5Seconds)
            .next(describeDatasetGroupStatus)
            .next(isComplete
            .when(sfn.Condition.stringEquals('$.status', 'CREATE PENDING'), setDescribeDatasetGroup)
            .when(sfn.Condition.stringEquals('$.status', 'CREATE IN_PROGRESS'), setDescribeDatasetGroup)
            .when(sfn.Condition.stringEquals('$.status', 'CREATE FAILED'), fail)
            .when(sfn.Condition.stringEquals('$.status', 'ACTIVE'), success));
        const schemaChain = sfn.Chain
            .start(setCreateSchema)
            .next(createSchema);
        const dsChain = sfn.Chain
            .start(setCreateDataset)
            .next(createDataset)
            .next(setDescribeDataset)
            .next(wait5Seconds)
            .next(describeDatasetStatus)
            .next(isComplete
            .when(sfn.Condition.stringEquals('$.status', 'CREATE PENDING'), setDescribeDataset)
            .when(sfn.Condition.stringEquals('$.status', 'CREATE IN_PROGRESS'), setDescribeDataset)
            .when(sfn.Condition.stringEquals('$.status', 'CREATE FAILED'), fail)
            .when(sfn.Condition.stringEquals('$.status', 'ACTIVE'), setCreateDatasetImportJob))
            .next(setCreateDatasetImportJob)
            .next(createDatasetImportJob)
            .next(setDescribeDatasetImportJob)
            .next(wait30Seconds)
            .next(describeDatasetImportJob)
            .next(isComplete
            .when(sfn.Condition.stringEquals('$.status', 'CREATE PENDING'), setDescribeDatasetImportJob)
            .when(sfn.Condition.stringEquals('$.status', 'CREATE IN_PROGRESS'), setDescribeDatasetImportJob)
            .when(sfn.Condition.stringEquals('$.status', 'CREATE FAILED'), fail)
            .when(sfn.Condition.stringEquals('$.status', 'ACTIVE'), success));
        new sfn.StateMachine(this, 'Create Personalize Dataset Group', {
            definition: dsgChain
        });
        new sfn.StateMachine(this, 'Create Personalize Schema', {
            definition: schemaChain
        });
        new sfn.StateMachine(this, 'Create Personalize Dataset', {
            definition: dsChain
        });
    }
}
const app = new cdk.App();
new PersonalizeManagementStack(app, 'personalize-management-app');
app.synth();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHFDQUFzQztBQUN0Qyx3Q0FBeUM7QUFDekMsa0RBQW1EO0FBQ25ELDhDQUErQztBQUMvQyw4REFBK0Q7QUFFL0QsTUFBTSwwQkFBMkIsU0FBUSxHQUFHLENBQUMsS0FBSztJQUM5QyxZQUFZLEtBQWMsRUFBRSxFQUFVLEVBQUUsUUFBd0IsRUFBRTtRQUM5RCxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUV4QixNQUFNLFFBQVEsR0FBRyxJQUFJLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLHdCQUF3QixFQUFFO1lBQ2pFLElBQUksRUFBRSxJQUFJLE1BQU0sQ0FBQyxTQUFTLENBQUMsaUJBQWlCLENBQUM7WUFDN0MsT0FBTyxFQUFFLHlCQUF5QjtZQUNsQyxPQUFPLEVBQUUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxXQUFXO1NBQ3BDLENBQUMsQ0FBQztRQUVMLElBQUcsUUFBUSxDQUFDLElBQUksRUFBRSxFQUFHLCtEQUErRDtZQUNoRixRQUFRLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsd0JBQXdCLENBQUMsMENBQTBDLENBQUMsQ0FBQyxDQUFDO1lBQ3ZILFFBQVEsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyx3QkFBd0IsQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDLENBQUM7U0FDdEc7UUFFRCxNQUFNLGtCQUFrQixHQUFHLElBQUksR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsc0JBQXNCLEVBQUU7WUFDbEUsSUFBSSxFQUFFLElBQUksU0FBUyxDQUFDLGNBQWMsQ0FBQyxRQUFRLENBQUM7U0FDL0MsQ0FBQyxDQUFDO1FBRUgsTUFBTSwwQkFBMEIsR0FBRyxJQUFJLEdBQUcsQ0FBQyxJQUFJ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R0FBRyxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsVUFBVSxFQUFFLFFBQVEsQ0FBQyxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUM7UUFFMUUsSUFBSSxHQUFHLENBQUMsWUFBWSxDQUFDLElBQUksRUFBRSxrQ0FBa0MsRUFBRTtZQUMzRCxVQUFVLEVBQUUsUUFBUTtTQUN2QixDQUFDLENBQUM7UUFFSCxJQUFJLEdBQUcsQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLDJCQUEyQixFQUFFO1lBQ3BELFVBQVUsRUFBRSxXQUFXO1NBQzFCLENBQUMsQ0FBQztRQUVILElBQUksR0FBRyxDQUFDLFlBQVksQ0FBQyxJQUFJLEVBQUUsNEJBQTRCLEVBQUU7WUFDckQsVUFBVSxFQUFFLE9BQU87U0FDdEIsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztDQUNKO0FBRUQsTUFBTSxHQUFHLEdBQUcsSUFBSSxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUM7QUFDMUIsSUFBSSwwQkFBMEIsQ0FBQyxHQUFHLEVBQUUsNEJBQTRCLENBQUMsQ0FBQztBQUNsRSxHQUFHLENBQUMsS0FBSyxFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgY2RrID0gcmVxdWlyZSgnQGF3cy1jZGsvY29yZScpO1xuaW1wb3J0IGlhbSA9IHJlcXVpcmUoXCJAYXdzLWNkay9hd3MtaWFtXCIpO1xuaW1wb3J0IHNmbiA9IHJlcXVpcmUoJ0Bhd3MtY2RrL2F3cy1zdGVwZnVuY3Rpb25zJyk7XG5pbXBvcnQgbGFtYmRhID0gcmVxdWlyZSgnQGF3cy1jZGsvYXdzLWxhbWJkYScpO1xuaW1wb3J0IHNmbl90YXNrcyA9IHJlcXVpcmUoJ0Bhd3MtY2RrL2F3cy1zdGVwZnVuY3Rpb25zLXRhc2tzJyk7XG5cbmNsYXNzIFBlcnNvbmFsaXplTWFuYWdlbWVudFN0YWNrIGV4dGVuZHMgY2RrLlN0YWNrIHtcbiAgICBjb25zdHJ1Y3RvcihzY29wZTogY2RrLkFwcCwgaWQ6IHN0cmluZywgcHJvcHM6IGNkay5TdGFja1Byb3BzID0ge30pIHtcbiAgICAgICAgc3VwZXIoc2NvcGUsIGlkLCBwcm9wcyk7XG5cbiAgICAgICAgY29uc3QgbGFtYmRhRm4gPSBuZXcgbGFtYmRhLkZ1bmN0aW9uKHRoaXMsICdQZXJzb25hbGl6ZUFQSUV4ZWN1dG9yJywge1xuICAgICAgICAgICAgY29kZTogbmV3IGxhbWJkYS5Bc3NldENvZGUoJ3Jlc291cmNlL2xhbWJkYScpLFxuICAgICAgICAgICAgaGFuZGxlcjogJ2FjdGlvbi1leGVjdXRvci5oYW5kbGVyJyxcbiAgICAgICAgICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLk5PREVKU18xMF9YLFxuICAgICAgICAgIH0pO1xuXG4gICAgICAgIGlmKGxhbWJkYUZuLnJvbGUpIHsgIC8vIFRoaXMgd2VpcmRuZXNzIGlzIHRvIGdldCBhcm91bmQgVHlwZVNjcmlwdCAndW5kZWZpbmVkJyBydWxlc1xuICAgICAgICAgICAgbGFtYmRhRm4ucm9sZS5hZGRNYW5hZ2VkUG9saWN5KGlhbS5NYW5hZ2VkUG9saWN5LmZyb21Bd3NNYW5hZ2VkUG9saWN5TmFtZSgnc2VydmljZS1yb2xlL0FtYXpvblBlcnNvbmFsaXplRnVsbEFjY2VzcycpKTtcbiAgICAgICAgICAgIGxhbWJkYUZuLnJvbGUuYWRkTWFuYWdlZFBvbGljeShpYW0uTWFuYWdlZFBvbGljeS5mcm9tQXdzTWFuYWdlZFBvbGljeU5hbWUoJ0Nsb3VkV2F0Y2hGdWxsQWNjZXNzJykpO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBjb25zdCBjcmVhdGVEYXRhc2V0R3JvdXAgPSBuZXcgc2ZuLlRhc2sodGhpcywgJ0NyZWF0ZSBEYXRhc2V0IEdyb3VwJywge1xuICAgICAgICAgICAgdGFzazogbmV3IHNmbl90YXNrcy5JbnZva2VGdW5jdGlvbihsYW1iZGFGbilcbiAgICAgICAgfSk7XG5cbiAgICAgICAgY29uc3QgZGVzY3JpYmVEYXRhc2V0R3JvdXBTdGF0dXMgPSBuZXcgc2ZuLlRhc2sodGhpcywgJ0Rlc2NyaWJlIERhdGFzZXQgR3JvdXAnLCB7XG4gICAgICAgICAgICB0YXNrOiBuZXcgc2ZuX3Rhc2tzLkludm9rZUZ1bmN0aW9uKGxhbWJkYUZuKSxcbiAgICAgICAgICAgIG91dHB1dFBhdGg6IFwiJC5kYXRhc2V0R3JvdXBcIlxuICAgICAgICB9KTtcblxuICAgICAgICBjb25zdCBjcmVhdGVEYXRhc2V0ID0gbmV3IHNmbi5UYXNrKHRoaXMsICdDcmVhdGUgRGF0YXNldCcsIHtcbiAgICAgICAgICAgIHRhc2s6IG5ldyBzZm5fdGFza3MuSW52b2tlRnVuY3Rpb24obGFtYmRhRm4pXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IGRlc2NyaWJlRGF0YXNldFN0YXR1cyA9IG5ldyBzZm4uVGFzayh0aGlzLCAnRGVzY3JpYmUgRGF0YXNldCcsIHtcbiAgICAgICAgICAgIHRhc2s6IG5ldyBzZm5fdGFza3MuSW52b2tlRnVuY3Rpb24obGFtYmRhRm4pLFxuICAgICAgICAgICAgb3V0cHV0UGF0aDogXCIkLmRhdGFzZXRcIlxuICAgICAgICB9KTtcblxuICAgICAgICBjb25zdCBkZXNjcmliZURhdGFzZXRJbXBvcnRKb2IgPSBuZXcgc2ZuLlRhc2sodGhpcywgJ0Rlc2NyaWJlIERhdGFzZXQgSW1wb3J0IEpvYicsIHtcbiAgICAgICAgICAgIHRhc2s6IG5ldyBzZm5fdGFza3MuSW52b2tlRnVuY3Rpb24obGFtYmRhRm4pLFxuICAgICAgICAgICAgb3V0cHV0UGF0aDogXCIkLmRhdGFzZXRJbXBvcnRKb2JcIlxuICAgICAgICB9KTtcblxuICAgICAgICBjb25zdCBjcmVhdGVEYXRhc2V0SW1wb3J0Sm9iID0gbmV3IHNmbi5UYXNrKHRoaXMsICdDcmVhdGUgRGF0YXNldCBJbXBvcnQgSm9iJywge1xuICAgICAgICAgICAgdGFzazogbmV3IHNmbl90YXNrcy5JbnZva2VGdW5jdGlvbihsYW1iZGFGbiksXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IGNyZWF0ZVNjaGVtYSA9IG5ldyBzZm4uVGFzayh0aGlzLCAnQ3JlYXRlIFNjaGVtYScsIHtcbiAgICAgICAgICAgIHRhc2s6IG5ldyBzZm5fdGFza3MuSW52b2tlRnVuY3Rpb24obGFtYmRhRm4pXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IHNldENyZWF0ZURhdGFzZXRHcm91cCA9IG5ldyBzZm4uUGFzcyh0aGlzLCAnU2V0IENyZWF0ZSBEYXRhc2V0IEdyb3VwJywge1xuICAgICAgICAgICAgcGFyYW1ldGVyczogeyB2ZXJiOiBcImNyZWF0ZURhdGFzZXRHcm91cFwiLCBwYXJhbXM6IHsgXCJuYW1lLiRcIjogXCIkLm5hbWVcIiB9IH0sXG4gICAgICAgICAgICByZXN1bHRQYXRoOiBcIiQuYWN0aW9uXCJcbiAgICAgICAgfSk7XG4gICAgICAgIFxuICAgICAgICBjb25zdCBzZXRDcmVhdGVEYXRhc2V0ID0gbmV3IHNmbi5QYXNzKHRoaXMsICdTZXQgQ3JlYXRlIERhdGFzZXQnLCB7XG4gICAgICAgICAgICBwYXJhbWV0ZXJzOiB7IFxuICAgICAgICAgICAgICAgIHZlcmI6IFwiY3JlYXRlRGF0YXNldFwiLCBcbiAgICAgICAgICAgICAgICBwYXJhbXM6IHsgXG4gICAgICAgICAgICAgICAgICAgIFwiZGF0YXNldEdyb3VwQXJuLiRcIjogXCIkLmRhdGFzZXRHcm91cEFyblwiLCBcbiAgICAgICAgICAgICAgICAgICAgXCJkYXRhc2V0VHlwZS4kXCI6IFwiJC5kYXRhc2V0VHlwZVwiLCBcbiAgICAgICAgICAgICAgICAgICAgXCJuYW1lLiRcIjogXCIkLm5hbWVcIixcbiAgICAgICAgICAgICAgICAgICAgXCJzY2hlbWFBcm4uJFwiOiBcIiQuc2NoZW1hQXJuXCIgXG4gICAgICAgICAgICAgICAgfSB9LFxuICAgICAgICAgICAgcmVzdWx0UGF0aDogXCIkLmFjdGlvblwiXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IHNldENyZWF0ZURhdGFzZXRJbXBvcnRKb2IgPSBuZXcgc2ZuLlBhc3ModGhpcywgJ1NldCBDcmVhdGUgRGF0YXNldCBJbXBvcnQgSm9iJywge1xuICAgICAgICAgICAgcGFyYW1ldGVyczogeyBcbiAgICAgICAgICAgICAgICB2ZXJiOiBcImNyZWF0ZURhdGFzZXRJbXBvcnRKb2JcIiwgXG4gICAgICAgICAgICAgICAgcGFyYW1zOiB7IFxuICAgICAgICAgICAgICAgICAgICBcImRhdGFTb3VyY2UuJFwiOiBcIiQuZGF0YVNvdXJjZVwiLCBcbiAgICAgICAgICAgICAgICAgICAgXCJkYXRhc2V0QXJuLiRcIjogXCIkLmRhdGFzZXRBcm5cIiwgXG4gICAgICAgICAgICAgICAgICAgIFwiam9iTmFtZS4kXCI6IFwiJC5qb2JOYW1lXCIsXG4gICAgICAgICAgICAgICAgICAgIFwicm9sZUFybi4kXCI6IFwiJC5yb2xlQXJuXCIgXG4gICAgICAgICAgICAgICAgfSB9LFxuICAgICAgICAgICAgcmVzdWx0UGF0aDogXCIkLmFjdGlvblwiXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IHNldERlc2NyaWJlRGF0YXNldCA9IG5ldyBzZm4uUGFzcyh0aGlzLCAnU2V0IERlc2NyaWJlIERhdGFzZXQnLCB7XG4gICAgICAgICAgICBwYXJhbWV0ZXJzOiB7IHZlcmI6IFwiZGVzY3JpYmVEYXRhc2V0XCIsIHBhcmFtczogeyBcImRhdGFzZXRBcm4uJFwiOiBcIiQuZGF0YXNldEFyblwiIH0gfSxcbiAgICAgICAgICAgIHJlc3VsdFBhdGg6IFwiJC5hY3Rpb25cIlxuICAgICAgICB9KTtcblxuICAgICAgICBjb25zdCBzZXREZXNjcmliZURhdGFzZXRJbXBvcnRKb2IgPSBuZXcgc2ZuLlBhc3ModGhpcywgJ1NldCBEZXNjcmliZSBEYXRhc2V0IEltcG9ydCBKb2InLCB7XG4gICAgICAgICAgICBwYXJhbWV0ZXJzOiB7IHZlcmI6IFwiZGVzY3JpYmVEYXRhc2V0SW1wb3J0Sm9iXCIsIHBhcmFtczogeyBcImRhdGFzZXRJbXBvcnRKb2JBcm4uJFwiOiBcIiQuZGF0YXNldEltcG9ydEpvYkFyblwiIH0gfSxcbiAgICAgICAgICAgIHJlc3VsdFBhdGg6IFwiJC5hY3Rpb25cIlxuICAgICAgICB9KTtcblxuICAgICAgICBjb25zdCBzZXREZXNjcmliZURhdGFzZXRHcm91cCA9IG5ldyBzZm4uUGFzcyh0aGlzLCAnU2V0IERlc2NyaWJlIERhdGFzZXQgR3JvdXAnLCB7XG4gICAgICAgICAgICBwYXJhbWV0ZXJzOiB7IHZlcmI6IFwiZGVzY3JpYmVEYXRhc2V0R3JvdXBcIiwgcGFyYW1zOiB7IFwiZGF0YXNldEdyb3VwQXJuLiRcIjogXCIkLmRhdGFzZXRHcm91cEFyblwiIH0gfSxcbiAgICAgICAgICAgIHJlc3VsdFBhdGg6IFwiJC5hY3Rpb25cIlxuICAgICAgICB9KTtcblxuICAgICAgICBjb25zdCBzZXRDcmVhdGVTY2hlbWEgPSBuZXcgc2ZuLlBhc3ModGhpcywgJ1NldCBDcmVhdGUgU2NoZW1hJywge1xuICAgICAgICAgICAgcGFyYW1ldGVyczogeyB2ZXJiOiBcImNyZWF0ZVNjaGVtYVwiLCBwYXJhbXM6IHsgXCJuYW1lLiRcIjogXCIkLm5hbWVcIiwgXCJzY2hlbWEuJFwiOiBcIiQuc2NoZW1hXCIgfSB9LFxuICAgICAgICAgICAgcmVzdWx0UGF0aDogXCIkLmFjdGlvblwiXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IHdhaXQ1U2Vjb25kcyA9IG5ldyBzZm4uV2FpdCh0aGlzLCAnV2FpdCA1IFNlY29uZHMnLCB7IFxuICAgICAgICAgICAgdGltZTogc2ZuLldhaXRUaW1lLmR1cmF0aW9uKGNkay5EdXJhdGlvbi5zZWNvbmRzKDUpKVxuICAgICAgICB9KTtcblxuICAgICAgICBjb25zdCB3YWl0MzBTZWNvbmRzID0gbmV3IHNmbi5XYWl0KHRoaXMsICdXYWl0IDMwIFNlY29uZHMnLCB7IFxuICAgICAgICAgICAgdGltZTogc2ZuLldhaXRUaW1lLmR1cmF0aW9uKGNkay5EdXJhdGlvbi5zZWNvbmRzKDMwKSlcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gVE9ETzogQWRkICdDYXRjaCcgdG8gc3RhdGVzIHRvIGNhcHR1cmUgZXhlY3V0aW9uIGVycm9ycyBhcyBwZXIgdGhpcyBibG9nOlxuICAgICAgICAvLyBodHRwczovL3RoZWJ1cm5pbmdtb25rLmNvbS8yMDE3LzA3L2FwcGx5aW5nLXRoZS1zYWdhLXBhdHRlcm4td2l0aC1hd3MtbGFtYmRhLWFuZC1zdGVwLWZ1bmN0aW9ucy9cblxuICAgICAgICBjb25zdCBmYWlsID0gbmV3IHNmbi5GYWlsKHRoaXMsICdDcmVhdGUgRmFpbGVkJyk7XG5cbiAgICAgICAgY29uc3Qgc3VjY2VzcyA9IG5ldyBzZm4uU3VjY2VlZCh0aGlzLCAnU3VjY2VzcycpO1xuXG4gICAgICAgIGNvbnN0IGlzQ29tcGxldGUgPSBuZXcgc2ZuLkNob2ljZSh0aGlzLCAnQ3JlYXRlIENvbXBsZXRlPycpO1xuXG4gICAgICAgIGNvbnN0IGRzZ0NoYWluID0gc2ZuLkNoYWluXG4gICAgICAgICAgICAuc3RhcnQoc2V0Q3JlYXRlRGF0YXNldEdyb3VwKVxuICAgICAgICAgICAgLm5leHQoY3JlYXRlRGF0YXNldEdyb3VwKVxuICAgICAgICAgICAgLm5leHQoc2V0RGVzY3JpYmVEYXRhc2V0R3JvdXApXG4gICAgICAgICAgICAubmV4dCh3YWl0NVNlY29uZHMpXG4gICAgICAgICAgICAubmV4dChkZXNjcmliZURhdGFzZXRHcm91cFN0YXR1cylcbiAgICAgICAgICAgIC5uZXh0KGlzQ29tcGxldGVcbiAgICAgICAgICAgICAgICAud2hlbihzZm4uQ29uZGl0aW9uLnN0cmluZ0VxdWFscygnJC5zdGF0dXMnLCAnQ1JFQVRFIFBFTkRJTkcnKSwgc2V0RGVzY3JpYmVEYXRhc2V0R3JvdXApXG4gICAgICAgICAgICAgICAgLndoZW4oc2ZuLkNvbmRpdGlvbi5zdHJpbmdFcXVhbHMoJyQuc3RhdHVzJywgJ0NSRUFURSBJTl9QUk9HUkVTUycpLCBzZXREZXNjcmliZURhdGFzZXRHcm91cClcbiAgICAgICAgICAgICAgICAud2hlbihzZm4uQ29uZGl0aW9uLnN0cmluZ0VxdWFscygnJC5zdGF0dXMnLCAnQ1JFQVRFIEZBSUxFRCcpLCBmYWlsKVxuICAgICAgICAgICAgICAgIC53aGVuKHNmbi5Db25kaXRpb24uc3RyaW5nRXF1YWxzKCckLnN0YXR1cycsICdBQ1RJVkUnKSwgc3VjY2VzcykpO1xuXG4gICAgICAgIGNvbnN0IHNjaGVtYUNoYWluID0gc2ZuLkNoYWluXG4gICAgICAgICAgICAuc3RhcnQoc2V0Q3JlYXRlU2NoZW1hKVxuICAgICAgICAgICAgLm5leHQoY3JlYXRlU2NoZW1hKVxuXG4gICAgICAgIGNvbnN0IGRzQ2hhaW4gPSBzZm4uQ2hhaW5cbiAgICAgICAgICAgIC5zdGFydChzZXRDcmVhdGVEYXRhc2V0KVxuICAgICAgICAgICAgLm5leHQoY3JlYXRlRGF0YXNldClcbiAgICAgICAgICAgIC5uZXh0KHNldERlc2NyaWJlRGF0YXNldClcbiAgICAgICAgICAgIC5uZXh0KHdhaXQ1U2Vjb25kcylcbiAgICAgICAgICAgIC5uZXh0KGRlc2NyaWJlRGF0YXNldFN0YXR1cylcbiAgICAgICAgICAgIC5uZXh0KGlzQ29tcGxldGVcbiAgICAgICAgICAgICAgICAud2hlbihzZm4uQ29uZGl0aW9uLnN0cmluZ0VxdWFscygnJC5zdGF0dXMnLCAnQ1JFQVRFIFBFTkRJTkcnKSwgc2V0RGVzY3JpYmVEYXRhc2V0KVxuICAgICAgICAgICAgICAgIC53aGVuKHNmbi5Db25kaXRpb24uc3RyaW5nRXF1YWxzKCckLnN0YXR1cycsICdDUkVBVEUgSU5fUFJPR1JFU1MnKSwgc2V0RGVzY3JpYmVEYXRhc2V0KVxuICAgICAgICAgICAgICAgIC53aGVuKHNmbi5Db25kaXRpb24uc3RyaW5nRXF1YWxzKCckLnN0YXR1cycsICdDUkVBVEUgRkFJTEVEJyksIGZhaWwpXG4gICAgICAgICAgICAgICAgLndoZW4oc2ZuLkNvbmRpdGlvbi5zdHJpbmdFcXVhbHMoJyQuc3RhdHVzJywgJ0FDVElWRScpLCBzZXRDcmVhdGVEYXRhc2V0SW1wb3J0Sm9iKSlcbiAgICAgICAgICAgIC5uZXh0KHNldENyZWF0ZURhdGFzZXRJbXBvcnRKb2IpXG4gICAgICAgICAgICAubmV4dChjcmVhdGVEYXRhc2V0SW1wb3J0Sm9iKVxuICAgICAgICAgICAgLm5leHQoc2V0RGVzY3JpYmVEYXRhc2V0SW1wb3J0Sm9iKVxuICAgICAgICAgICAgLm5leHQod2FpdDMwU2Vjb25kcylcbiAgICAgICAgICAgIC5uZXh0KGRlc2NyaWJlRGF0YXNldEltcG9ydEpvYilcbiAgICAgICAgICAgIC5uZXh0KGlzQ29tcGxldGVcbiAgICAgICAgICAgICAgICAud2hlbihzZm4uQ29uZGl0aW9uLnN0cmluZ0VxdWFscygnJC5zdGF0dXMnLCAnQ1JFQVRFIFBFTkRJTkcnKSwgc2V0RGVzY3JpYmVEYXRhc2V0SW1wb3J0Sm9iKVxuICAgICAgICAgICAgICAgIC53aGVuKHNmbi5Db25kaXRpb24uc3RyaW5nRXF1YWxzKCckLnN0YXR1cycsICdDUkVBVEUgSU5fUFJPR1JFU1MnKSwgc2V0RGVzY3JpYmVEYXRhc2V0SW1wb3J0Sm9iKVxuICAgICAgICAgICAgICAgIC53aGVuKHNmbi5Db25kaXRpb24uc3RyaW5nRXF1YWxzKCckLnN0YXR1cycsICdDUkVBVEUgRkFJTEVEJyksIGZhaWwpXG4gICAgICAgICAgICAgICAgLndoZW4oc2ZuLkNvbmRpdGlvbi5zdHJpbmdFcXVhbHMoJyQuc3RhdHVzJywgJ0FDVElWRScpLCBzdWNjZXNzKSk7XG5cbiAgICAgICAgbmV3IHNmbi5TdGF0ZU1hY2hpbmUodGhpcywgJ0NyZWF0ZSBQZXJzb25hbGl6ZSBEYXRhc2V0IEdyb3VwJywge1xuICAgICAgICAgICAgZGVmaW5pdGlvbjogZHNnQ2hhaW5cbiAgICAgICAgfSk7XG5cbiAgICAgICAgbmV3IHNmbi5TdGF0ZU1hY2hpbmUodGhpcywgJ0NyZWF0ZSBQZXJzb25hbGl6ZSBTY2hlbWEnLCB7XG4gICAgICAgICAgICBkZWZpbml0aW9uOiBzY2hlbWFDaGFpblxuICAgICAgICB9KTtcblxuICAgICAgICBuZXcgc2ZuLlN0YXRlTWFjaGluZSh0aGlzLCAnQ3JlYXRlIFBlcnNvbmFsaXplIERhdGFzZXQnLCB7XG4gICAgICAgICAgICBkZWZpbml0aW9uOiBkc0NoYWluXG4gICAgICAgIH0pO1xuICAgIH1cbn1cblxuY29uc3QgYXBwID0gbmV3IGNkay5BcHAoKTtcbm5ldyBQZXJzb25hbGl6ZU1hbmFnZW1lbnRTdGFjayhhcHAsICdwZXJzb25hbGl6ZS1tYW5hZ2VtZW50LWFwcCcpO1xuYXBwLnN5bnRoKCk7XG4iXX0=