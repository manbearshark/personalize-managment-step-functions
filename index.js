"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const cdk = require("@aws-cdk/core");
const iam = require("@aws-cdk/aws-iam");
const sfn = require("@aws-cdk/aws-stepfunctions");
const lambda = require("@aws-cdk/aws-lambda");
const sfn_tasks = require("@aws-cdk/aws-stepfunctions-tasks");
const s3 = require("@aws-cdk/aws-s3");
const DATA_BUCKET_NAME = 'personalize-data';
class PersonalizeManagementStack extends cdk.Stack {
    constructor(scope, id, props = {}) {
        super(scope, id, props);
        const lambdaFn = new lambda.Function(this, 'PersonalizeAPIExecutor', {
            code: new lambda.AssetCode('resource/lambda'),
            handler: 'action-executor.handler',
            runtime: lambda.Runtime.NODEJS_10_X,
        });
        const dataBucket = new s3.Bucket(this, 'dataBucket', {
            bucketName: DATA_BUCKET_NAME,
            publicReadAccess: false
        });
        dataBucket.grantReadWrite(lambdaFn); // Not strictly required but may be handy
        if (lambdaFn.role) { // This weirdness is to get around TypeScript 'undefined' rules
            lambdaFn.role.addManagedPolicy(iam.ManagedPolicy.fromAwsManagedPolicyName('service-role/AmazonPersonalizeFullAccess'));
            lambdaFn.role.addManagedPolicy(iam.ManagedPolicy.fromAwsManagedPolicyName('CloudWatchFullAccess'));
        }
        const personalizeRole = new iam.Role(this, 'PersonalizeExecutionRole', {
            assumedBy: new iam.ServicePrincipal('personalize.amazonaws.com')
        });
        personalizeRole.addToPolicy(new iam.PolicyStatement({
            actions: ["s3:GetObject", "s3:ListBucket"],
            resources: [dataBucket.bucketArn, dataBucket.bucketArn + '/*'],
        }));
        personalizeRole.addManagedPolicy(iam.ManagedPolicy.fromAwsManagedPolicyName('service-role/AmazonPersonalizeFullAccess'));
        personalizeRole.addManagedPolicy(iam.ManagedPolicy.fromAwsManagedPolicyName('CloudWatchFullAccess'));
        const createDatasetGroup = new sfn.Task(this, 'Create Dataset Group', {
            task: new sfn_tasks.InvokeFunction(lambdaFn)
        });
        const describeDatasetGroupStatus = new sfn.Task(this, 'Describe Dataset Group', {
            task: new sfn_tasks.InvokeFunction(lambdaFn),
            outputPath: "$.datasetGroup"
        });
        const createDataset = new sfn.Task(this, 'Create Dataset', {
            task: new sfn_tasks.InvokeFunction(lambdaFn)
        });
        const describeDatasetStatus = new sfn.Task(this, 'Describe Dataset', {
            task: new sfn_tasks.InvokeFunction(lambdaFn),
            outputPath: "$.dataset"
        });
        const describeDatasetImportJob = new sfn.Task(this, 'Describe Dataset Import Job', {
            task: new sfn_tasks.InvokeFunction(lambdaFn),
            outputPath: "$.datasetImportJob"
        });
        const createDatasetImportJob = new sfn.Task(this, 'Create Dataset Import Job', {
            task: new sfn_tasks.InvokeFunction(lambdaFn),
        });
        const createSchema = new sfn.Task(this, 'Create Schema', {
            task: new sfn_tasks.InvokeFunction(lambdaFn)
        });
        const setCreateDatasetGroup = new sfn.Pass(this, 'Set Create Dataset Group', {
            parameters: { verb: "createDatasetGroup", params: { "name.$": "$.name" } },
            resultPath: "$.action"
        });
        const setCreateDataset = new sfn.Pass(this, 'Set Create Dataset', {
            parameters: {
                verb: "createDataset",
                params: {
                    "datasetGroupArn.$": "$.datasetGroupArn",
                    "datasetType.$": "$.datasetType",
                    "name.$": "$.name",
                    "schemaArn.$": "$.schemaArn"
                }
            },
            resultPath: "$.action"
        });
        const setCreateDatasetImportJob = new sfn.Pass(this, 'Set Create Dataset Import Job', {
            parameters: {
                verb: "createDatasetImportJob",
                params: {
                    "dataSource.$": "$.dataSource",
                    "datasetArn.$": "$.datasetArn",
                    "jobName.$": "$.jobName",
                    "roleArn.$": "$.roleArn"
                }
            },
            resultPath: "$.action"
        });
        const setDescribeDataset = new sfn.Pass(this, 'Set Describe Dataset', {
            parameters: { verb: "describeDataset", params: { "datasetArn.$": "$.datasetArn" } },
            resultPath: "$.action"
        });
        const setDescribeDatasetImportJob = new sfn.Pass(this, 'Set Describe Dataset Import Job', {
            parameters: { verb: "describeDatasetImportJob", params: { "datasetImportJobArn.$": "$.datasetImportJobArn" } },
            resultPath: "$.action"
        });
        const setDescribeDatasetGroup = new sfn.Pass(this, 'Set Describe Dataset Group', {
            parameters: { verb: "describeDatasetGroup", params: { "datasetGroupArn.$": "$.datasetGroupArn" } },
            resultPath: "$.action"
        });
        const setCreateSchema = new sfn.Pass(this, 'Set Create Schema', {
            parameters: { verb: "createSchema", params: { "name.$": "$.name", "schema.$": "$.schema" } },
            resultPath: "$.action"
        });
        const wait5Seconds = new sfn.Wait(this, 'Wait 5 Seconds', {
            time: sfn.WaitTime.duration(cdk.Duration.seconds(5))
        });
        const wait30Seconds = new sfn.Wait(this, 'Wait 30 Seconds', {
            time: sfn.WaitTime.duration(cdk.Duration.seconds(30))
        });
        // TODO: Add 'Catch' to states to capture execution errors as per this blog:
        // https://theburningmonk.com/2017/07/applying-the-saga-pattern-with-aws-lambda-and-step-functions/
        const fail = new sfn.Fail(this, 'Create Failed');
        const success = new sfn.Succeed(this, 'Success');
        const isComplete = new sfn.Choice(this, 'Create Complete?');
        const dsgChain = sfn.Chain
            .start(setCreateDatasetGroup)
            .next(createDatasetGroup)
            .next(setDescribeDatasetGroup)
            .next(wait5Seconds)
            .next(describeDatasetGroupStatus)
            .next(isComplete
            .when(sfn.Condition.stringEquals('$.status', 'CREATE PENDING'), setDescribeDatasetGroup)
            .when(sfn.Condition.stringEquals('$.status', 'CREATE IN_PROGRESS'), setDescribeDatasetGroup)
            .when(sfn.Condition.stringEquals('$.status', 'CREATE FAILED'), fail)
            .when(sfn.Condition.stringEquals('$.status', 'ACTIVE'), success));
        const schemaChain = sfn.Chain
            .start(setCreateSchema)
            .next(createSchema);
        const dsChain = sfn.Chain
            .start(setCreateDataset)
            .next(createDataset)
            .next(setDescribeDataset)
            .next(wait5Seconds)
            .next(describeDatasetStatus)
            .next(isComplete
            .when(sfn.Condition.stringEquals('$.status', 'CREATE PENDING'), setDescribeDataset)
            .when(sfn.Condition.stringEquals('$.status', 'CREATE IN_PROGRESS'), setDescribeDataset)
            .when(sfn.Condition.stringEquals('$.status', 'CREATE FAILED'), fail)
            .when(sfn.Condition.stringEquals('$.status', 'ACTIVE'), setCreateDatasetImportJob))
            .next(setCreateDatasetImportJob)
            .next(createDatasetImportJob)
            .next(setDescribeDatasetImportJob)
            .next(wait30Seconds)
            .next(describeDatasetImportJob)
            .next(isComplete
            .when(sfn.Condition.stringEquals('$.status', 'CREATE PENDING'), setDescribeDatasetImportJob)
            .when(sfn.Condition.stringEquals('$.status', 'CREATE IN_PROGRESS'), setDescribeDatasetImportJob)
            .when(sfn.Condition.stringEquals('$.status', 'CREATE FAILED'), fail)
            .when(sfn.Condition.stringEquals('$.status', 'ACTIVE'), success));
        new sfn.StateMachine(this, 'Create Personalize Dataset Group', {
            definition: dsgChain
        });
        new sfn.StateMachine(this, 'Create Personalize Schema', {
            definition: schemaChain
        });
        new sfn.StateMachine(this, 'Create Personalize Dataset', {
            definition: dsChain
        });
    }
}
const app = new cdk.App();
new PersonalizeManagementStack(app, 'personalize-management-app');
app.synth();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHFDQUFzQztBQUN0Qyx3Q0FBeUM7QUFDekMsa0RBQW1EO0FBQ25ELDhDQUErQztBQUMvQyw4REFBK0Q7QUFDL0Qsc0NBQXVDO0FBRXZDLE1BQU0sZ0JBQWdCLEdBQUcsa0JBQWtCLENBQUM7QUFFNUMsTUFBTSwwQkFBMkIsU0FBUSxHQUFHLENBQUMsS0FBSztJQUM5QyxZQUFZLEtBQWMsRUFBRSxFQUFVLEVBQUUsUUFBd0IsRUFBRTtRQUM5RCxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUV4QixNQUFNLFFBQVEsR0FBRyxJQUFJLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLHdCQUF3QixFQUFFO1lBQ2pFLElBQUksRUFBRSxJQUFJLE1BQU0sQ0FBQyxTQUFTLENBQUMsaUJBQWlCLENBQUM7WUFDN0MsT0FBTyxFQUFFLHlCQUF5QjtZQUNsQyxPQUFPLEVBQUUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxXQUFXO1NBQ3RDLENBQUMsQ0FBQztRQUVILE1BQU0sVUFBVSxHQUFHLElBQUksRUFBRSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsWUFBWSxFQUFFO1lBQ2pELFVBQVUsRUFBRSxnQkFBZ0I7WUFDNUIsZ0JBQWdCLEVBQUUsS0FBSztTQUMxQixDQUFDLENBQUM7UUFFSCxVQUFVLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUUseUNBQXlDO1FBRS9FLElBQUcsUUFBUSxDQUFDLElBQUksRUFBRSxFQUFHLCtEQUErRDtZQUNoRixRQUFRLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsd0JBQXdCLENBQUMsMENBQTBDLENBQUMsQ0FBQyxDQUFDO1lBQ3ZILFFBQVEsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxDQUFD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QVksQ0FBQyxJQUFJLEVBQUUsMkJBQTJCLEVBQUU7WUFDcEQsVUFBVSxFQUFFLFdBQVc7U0FDMUIsQ0FBQyxDQUFDO1FBRUgsSUFBSSxHQUFHLENBQUMsWUFBWSxDQUFDLElBQUksRUFBRSw0QkFBNEIsRUFBRTtZQUNyRCxVQUFVLEVBQUUsT0FBTztTQUN0QixDQUFDLENBQUM7SUFDUCxDQUFDO0NBQ0o7QUFFRCxNQUFNLEdBQUcsR0FBRyxJQUFJLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQztBQUMxQixJQUFJLDBCQUEwQixDQUFDLEdBQUcsRUFBRSw0QkFBNEIsQ0FBQyxDQUFDO0FBQ2xFLEdBQUcsQ0FBQyxLQUFLLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBjZGsgPSByZXF1aXJlKCdAYXdzLWNkay9jb3JlJyk7XG5pbXBvcnQgaWFtID0gcmVxdWlyZShcIkBhd3MtY2RrL2F3cy1pYW1cIik7XG5pbXBvcnQgc2ZuID0gcmVxdWlyZSgnQGF3cy1jZGsvYXdzLXN0ZXBmdW5jdGlvbnMnKTtcbmltcG9ydCBsYW1iZGEgPSByZXF1aXJlKCdAYXdzLWNkay9hd3MtbGFtYmRhJyk7XG5pbXBvcnQgc2ZuX3Rhc2tzID0gcmVxdWlyZSgnQGF3cy1jZGsvYXdzLXN0ZXBmdW5jdGlvbnMtdGFza3MnKTtcbmltcG9ydCBzMyA9IHJlcXVpcmUoJ0Bhd3MtY2RrL2F3cy1zMycpO1xuXG5jb25zdCBEQVRBX0JVQ0tFVF9OQU1FID0gJ3BlcnNvbmFsaXplLWRhdGEnO1xuXG5jbGFzcyBQZXJzb25hbGl6ZU1hbmFnZW1lbnRTdGFjayBleHRlbmRzIGNkay5TdGFjayB7XG4gICAgY29uc3RydWN0b3Ioc2NvcGU6IGNkay5BcHAsIGlkOiBzdHJpbmcsIHByb3BzOiBjZGsuU3RhY2tQcm9wcyA9IHt9KSB7XG4gICAgICAgIHN1cGVyKHNjb3BlLCBpZCwgcHJvcHMpO1xuXG4gICAgICAgIGNvbnN0IGxhbWJkYUZuID0gbmV3IGxhbWJkYS5GdW5jdGlvbih0aGlzLCAnUGVyc29uYWxpemVBUElFeGVjdXRvcicsIHtcbiAgICAgICAgICAgIGNvZGU6IG5ldyBsYW1iZGEuQXNzZXRDb2RlKCdyZXNvdXJjZS9sYW1iZGEnKSxcbiAgICAgICAgICAgIGhhbmRsZXI6ICdhY3Rpb24tZXhlY3V0b3IuaGFuZGxlcicsXG4gICAgICAgICAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMTBfWCxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgY29uc3QgZGF0YUJ1Y2tldCA9IG5ldyBzMy5CdWNrZXQodGhpcywgJ2RhdGFCdWNrZXQnLCB7IFxuICAgICAgICAgICAgYnVja2V0TmFtZTogREFUQV9CVUNLRVRfTkFNRSxcbiAgICAgICAgICAgIHB1YmxpY1JlYWRBY2Nlc3M6IGZhbHNlXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGRhdGFCdWNrZXQuZ3JhbnRSZWFkV3JpdGUobGFtYmRhRm4pOyAgLy8gTm90IHN0cmljdGx5IHJlcXVpcmVkIGJ1dCBtYXkgYmUgaGFuZHlcbiAgICAgICAgXG4gICAgICAgIGlmKGxhbWJkYUZuLnJvbGUpIHsgIC8vIFRoaXMgd2VpcmRuZXNzIGlzIHRvIGdldCBhcm91bmQgVHlwZVNjcmlwdCAndW5kZWZpbmVkJyBydWxlc1xuICAgICAgICAgICAgbGFtYmRhRm4ucm9sZS5hZGRNYW5hZ2VkUG9saWN5KGlhbS5NYW5hZ2VkUG9saWN5LmZyb21Bd3NNYW5hZ2VkUG9saWN5TmFtZSgnc2VydmljZS1yb2xlL0FtYXpvblBlcnNvbmFsaXplRnVsbEFjY2VzcycpKTtcbiAgICAgICAgICAgIGxhbWJkYUZuLnJvbGUuYWRkTWFuYWdlZFBvbGljeShpYW0uTWFuYWdlZFBvbGljeS5mcm9tQXdzTWFuYWdlZFBvbGljeU5hbWUoJ0Nsb3VkV2F0Y2hGdWxsQWNjZXNzJykpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcGVyc29uYWxpemVSb2xlID0gbmV3IGlhbS5Sb2xlKHRoaXMsICdQZXJzb25hbGl6ZUV4ZWN1dGlvblJvbGUnLCB7XG4gICAgICAgICAgICBhc3N1bWVkQnk6IG5ldyBpYW0uU2VydmljZVByaW5jaXBhbCgncGVyc29uYWxpemUuYW1hem9uYXdzLmNvbScpXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHBlcnNvbmFsaXplUm9sZS5hZGRUb1BvbGljeShuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgICAgICBhY3Rpb25zOiBbIFwiczM6R2V0T2JqZWN0XCIsIFwiczM6TGlzdEJ1Y2tldFwiIF0sXG4gICAgICAgICAgICByZXNvdXJjZXM6IFsgZGF0YUJ1Y2tldC5idWNrZXRBcm4sIGRhdGFCdWNrZXQuYnVja2V0QXJuICsgJy8qJyBdLFxuICAgICAgICB9KSk7XG5cbiAgICAgICAgcGVyc29uYWxpemVSb2xlLmFkZE1hbmFnZWRQb2xpY3koaWFtLk1hbmFnZWRQb2xpY3kuZnJvbUF3c01hbmFnZWRQb2xpY3lOYW1lKCdzZXJ2aWNlLXJvbGUvQW1hem9uUGVyc29uYWxpemVGdWxsQWNjZXNzJykpO1xuICAgICAgICBwZXJzb25hbGl6ZVJvbGUuYWRkTWFuYWdlZFBvbGljeShpYW0uTWFuYWdlZFBvbGljeS5mcm9tQXdzTWFuYWdlZFBvbGljeU5hbWUoJ0Nsb3VkV2F0Y2hGdWxsQWNjZXNzJykpO1xuXG4gICAgICAgIGNvbnN0IGNyZWF0ZURhdGFzZXRHcm91cCA9IG5ldyBzZm4uVGFzayh0aGlzLCAnQ3JlYXRlIERhdGFzZXQgR3JvdXAnLCB7XG4gICAgICAgICAgICB0YXNrOiBuZXcgc2ZuX3Rhc2tzLkludm9rZUZ1bmN0aW9uKGxhbWJkYUZuKVxuICAgICAgICB9KTtcblxuICAgICAgICBjb25zdCBkZXNjcmliZURhdGFzZXRHcm91cFN0YXR1cyA9IG5ldyBzZm4uVGFzayh0aGlzLCAnRGVzY3JpYmUgRGF0YXNldCBHcm91cCcsIHtcbiAgICAgICAgICAgIHRhc2s6IG5ldyBzZm5fdGFza3MuSW52b2tlRnVuY3Rpb24obGFtYmRhRm4pLFxuICAgICAgICAgICAgb3V0cHV0UGF0aDogXCIkLmRhdGFzZXRHcm91cFwiXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IGNyZWF0ZURhdGFzZXQgPSBuZXcgc2ZuLlRhc2sodGhpcywgJ0NyZWF0ZSBEYXRhc2V0Jywge1xuICAgICAgICAgICAgdGFzazogbmV3IHNmbl90YXNrcy5JbnZva2VGdW5jdGlvbihsYW1iZGFGbilcbiAgICAgICAgfSk7XG5cbiAgICAgICAgY29uc3QgZGVzY3JpYmVEYXRhc2V0U3RhdHVzID0gbmV3IHNmbi5UYXNrKHRoaXMsICdEZXNjcmliZSBEYXRhc2V0Jywge1xuICAgICAgICAgICAgdGFzazogbmV3IHNmbl90YXNrcy5JbnZva2VGdW5jdGlvbihsYW1iZGFGbiksXG4gICAgICAgICAgICBvdXRwdXRQYXRoOiBcIiQuZGF0YXNldFwiXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IGRlc2NyaWJlRGF0YXNldEltcG9ydEpvYiA9IG5ldyBzZm4uVGFzayh0aGlzLCAnRGVzY3JpYmUgRGF0YXNldCBJbXBvcnQgSm9iJywge1xuICAgICAgICAgICAgdGFzazogbmV3IHNmbl90YXNrcy5JbnZva2VGdW5jdGlvbihsYW1iZGFGbiksXG4gICAgICAgICAgICBvdXRwdXRQYXRoOiBcIiQuZGF0YXNldEltcG9ydEpvYlwiXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IGNyZWF0ZURhdGFzZXRJbXBvcnRKb2IgPSBuZXcgc2ZuLlRhc2sodGhpcywgJ0NyZWF0ZSBEYXRhc2V0IEltcG9ydCBKb2InLCB7XG4gICAgICAgICAgICB0YXNrOiBuZXcgc2ZuX3Rhc2tzLkludm9rZUZ1bmN0aW9uKGxhbWJkYUZuKSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgY29uc3QgY3JlYXRlU2NoZW1hID0gbmV3IHNmbi5UYXNrKHRoaXMsICdDcmVhdGUgU2NoZW1hJywge1xuICAgICAgICAgICAgdGFzazogbmV3IHNmbl90YXNrcy5JbnZva2VGdW5jdGlvbihsYW1iZGFGbilcbiAgICAgICAgfSk7XG5cbiAgICAgICAgY29uc3Qgc2V0Q3JlYXRlRGF0YXNldEdyb3VwID0gbmV3IHNmbi5QYXNzKHRoaXMsICdTZXQgQ3JlYXRlIERhdGFzZXQgR3JvdXAnLCB7XG4gICAgICAgICAgICBwYXJhbWV0ZXJzOiB7IHZlcmI6IFwiY3JlYXRlRGF0YXNldEdyb3VwXCIsIHBhcmFtczogeyBcIm5hbWUuJFwiOiBcIiQubmFtZVwiIH0gfSxcbiAgICAgICAgICAgIHJlc3VsdFBhdGg6IFwiJC5hY3Rpb25cIlxuICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IHNldENyZWF0ZURhdGFzZXQgPSBuZXcgc2ZuLlBhc3ModGhpcywgJ1NldCBDcmVhdGUgRGF0YXNldCcsIHtcbiAgICAgICAgICAgIHBhcmFtZXRlcnM6IHsgXG4gICAgICAgICAgICAgICAgdmVyYjogXCJjcmVhdGVEYXRhc2V0XCIsIFxuICAgICAgICAgICAgICAgIHBhcmFtczogeyBcbiAgICAgICAgICAgICAgICAgICAgXCJkYXRhc2V0R3JvdXBBcm4uJFwiOiBcIiQuZGF0YXNldEdyb3VwQXJuXCIsIFxuICAgICAgICAgICAgICAgICAgICBcImRhdGFzZXRUeXBlLiRcIjogXCIkLmRhdGFzZXRUeXBlXCIsIFxuICAgICAgICAgICAgICAgICAgICBcIm5hbWUuJFwiOiBcIiQubmFtZVwiLFxuICAgICAgICAgICAgICAgICAgICBcInNjaGVtYUFybi4kXCI6IFwiJC5zY2hlbWFBcm5cIiBcbiAgICAgICAgICAgICAgICB9IH0sXG4gICAgICAgICAgICByZXN1bHRQYXRoOiBcIiQuYWN0aW9uXCJcbiAgICAgICAgfSk7XG5cbiAgICAgICAgY29uc3Qgc2V0Q3JlYXRlRGF0YXNldEltcG9ydEpvYiA9IG5ldyBzZm4uUGFzcyh0aGlzLCAnU2V0IENyZWF0ZSBEYXRhc2V0IEltcG9ydCBKb2InLCB7XG4gICAgICAgICAgICBwYXJhbWV0ZXJzOiB7IFxuICAgICAgICAgICAgICAgIHZlcmI6IFwiY3JlYXRlRGF0YXNldEltcG9ydEpvYlwiLCBcbiAgICAgICAgICAgICAgICBwYXJhbXM6IHsgXG4gICAgICAgICAgICAgICAgICAgIFwiZGF0YVNvdXJjZS4kXCI6IFwiJC5kYXRhU291cmNlXCIsIFxuICAgICAgICAgICAgICAgICAgICBcImRhdGFzZXRBcm4uJFwiOiBcIiQuZGF0YXNldEFyblwiLCBcbiAgICAgICAgICAgICAgICAgICAgXCJqb2JOYW1lLiRcIjogXCIkLmpvYk5hbWVcIixcbiAgICAgICAgICAgICAgICAgICAgXCJyb2xlQXJuLiRcIjogXCIkLnJvbGVBcm5cIiBcbiAgICAgICAgICAgICAgICB9IH0sXG4gICAgICAgICAgICByZXN1bHRQYXRoOiBcIiQuYWN0aW9uXCJcbiAgICAgICAgfSk7XG5cbiAgICAgICAgY29uc3Qgc2V0RGVzY3JpYmVEYXRhc2V0ID0gbmV3IHNmbi5QYXNzKHRoaXMsICdTZXQgRGVzY3JpYmUgRGF0YXNldCcsIHtcbiAgICAgICAgICAgIHBhcmFtZXRlcnM6IHsgdmVyYjogXCJkZXNjcmliZURhdGFzZXRcIiwgcGFyYW1zOiB7IFwiZGF0YXNldEFybi4kXCI6IFwiJC5kYXRhc2V0QXJuXCIgfSB9LFxuICAgICAgICAgICAgcmVzdWx0UGF0aDogXCIkLmFjdGlvblwiXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IHNldERlc2NyaWJlRGF0YXNldEltcG9ydEpvYiA9IG5ldyBzZm4uUGFzcyh0aGlzLCAnU2V0IERlc2NyaWJlIERhdGFzZXQgSW1wb3J0IEpvYicsIHtcbiAgICAgICAgICAgIHBhcmFtZXRlcnM6IHsgdmVyYjogXCJkZXNjcmliZURhdGFzZXRJbXBvcnRKb2JcIiwgcGFyYW1zOiB7IFwiZGF0YXNldEltcG9ydEpvYkFybi4kXCI6IFwiJC5kYXRhc2V0SW1wb3J0Sm9iQXJuXCIgfSB9LFxuICAgICAgICAgICAgcmVzdWx0UGF0aDogXCIkLmFjdGlvblwiXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IHNldERlc2NyaWJlRGF0YXNldEdyb3VwID0gbmV3IHNmbi5QYXNzKHRoaXMsICdTZXQgRGVzY3JpYmUgRGF0YXNldCBHcm91cCcsIHtcbiAgICAgICAgICAgIHBhcmFtZXRlcnM6IHsgdmVyYjogXCJkZXNjcmliZURhdGFzZXRHcm91cFwiLCBwYXJhbXM6IHsgXCJkYXRhc2V0R3JvdXBBcm4uJFwiOiBcIiQuZGF0YXNldEdyb3VwQXJuXCIgfSB9LFxuICAgICAgICAgICAgcmVzdWx0UGF0aDogXCIkLmFjdGlvblwiXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IHNldENyZWF0ZVNjaGVtYSA9IG5ldyBzZm4uUGFzcyh0aGlzLCAnU2V0IENyZWF0ZSBTY2hlbWEnLCB7XG4gICAgICAgICAgICBwYXJhbWV0ZXJzOiB7IHZlcmI6IFwiY3JlYXRlU2NoZW1hXCIsIHBhcmFtczogeyBcIm5hbWUuJFwiOiBcIiQubmFtZVwiLCBcInNjaGVtYS4kXCI6IFwiJC5zY2hlbWFcIiB9IH0sXG4gICAgICAgICAgICByZXN1bHRQYXRoOiBcIiQuYWN0aW9uXCJcbiAgICAgICAgfSk7XG5cbiAgICAgICAgY29uc3Qgd2FpdDVTZWNvbmRzID0gbmV3IHNmbi5XYWl0KHRoaXMsICdXYWl0IDUgU2Vjb25kcycsIHsgXG4gICAgICAgICAgICB0aW1lOiBzZm4uV2FpdFRpbWUuZHVyYXRpb24oY2RrLkR1cmF0aW9uLnNlY29uZHMoNSkpXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IHdhaXQzMFNlY29uZHMgPSBuZXcgc2ZuLldhaXQodGhpcywgJ1dhaXQgMzAgU2Vjb25kcycsIHsgXG4gICAgICAgICAgICB0aW1lOiBzZm4uV2FpdFRpbWUuZHVyYXRpb24oY2RrLkR1cmF0aW9uLnNlY29uZHMoMzApKVxuICAgICAgICB9KTtcblxuICAgICAgICAvLyBUT0RPOiBBZGQgJ0NhdGNoJyB0byBzdGF0ZXMgdG8gY2FwdHVyZSBleGVjdXRpb24gZXJyb3JzIGFzIHBlciB0aGlzIGJsb2c6XG4gICAgICAgIC8vIGh0dHBzOi8vdGhlYnVybmluZ21vbmsuY29tLzIwMTcvMDcvYXBwbHlpbmctdGhlLXNhZ2EtcGF0dGVybi13aXRoLWF3cy1sYW1iZGEtYW5kLXN0ZXAtZnVuY3Rpb25zL1xuXG4gICAgICAgIGNvbnN0IGZhaWwgPSBuZXcgc2ZuLkZhaWwodGhpcywgJ0NyZWF0ZSBGYWlsZWQnKTtcblxuICAgICAgICBjb25zdCBzdWNjZXNzID0gbmV3IHNmbi5TdWNjZWVkKHRoaXMsICdTdWNjZXNzJyk7XG5cbiAgICAgICAgY29uc3QgaXNDb21wbGV0ZSA9IG5ldyBzZm4uQ2hvaWNlKHRoaXMsICdDcmVhdGUgQ29tcGxldGU/Jyk7XG5cbiAgICAgICAgY29uc3QgZHNnQ2hhaW4gPSBzZm4uQ2hhaW5cbiAgICAgICAgICAgIC5zdGFydChzZXRDcmVhdGVEYXRhc2V0R3JvdXApXG4gICAgICAgICAgICAubmV4dChjcmVhdGVEYXRhc2V0R3JvdXApXG4gICAgICAgICAgICAubmV4dChzZXREZXNjcmliZURhdGFzZXRHcm91cClcbiAgICAgICAgICAgIC5uZXh0KHdhaXQ1U2Vjb25kcylcbiAgICAgICAgICAgIC5uZXh0KGRlc2NyaWJlRGF0YXNldEdyb3VwU3RhdHVzKVxuICAgICAgICAgICAgLm5leHQoaXNDb21wbGV0ZVxuICAgICAgICAgICAgICAgIC53aGVuKHNmbi5Db25kaXRpb24uc3RyaW5nRXF1YWxzKCckLnN0YXR1cycsICdDUkVBVEUgUEVORElORycpLCBzZXREZXNjcmliZURhdGFzZXRHcm91cClcbiAgICAgICAgICAgICAgICAud2hlbihzZm4uQ29uZGl0aW9uLnN0cmluZ0VxdWFscygnJC5zdGF0dXMnLCAnQ1JFQVRFIElOX1BST0dSRVNTJyksIHNldERlc2NyaWJlRGF0YXNldEdyb3VwKVxuICAgICAgICAgICAgICAgIC53aGVuKHNmbi5Db25kaXRpb24uc3RyaW5nRXF1YWxzKCckLnN0YXR1cycsICdDUkVBVEUgRkFJTEVEJyksIGZhaWwpXG4gICAgICAgICAgICAgICAgLndoZW4oc2ZuLkNvbmRpdGlvbi5zdHJpbmdFcXVhbHMoJyQuc3RhdHVzJywgJ0FDVElWRScpLCBzdWNjZXNzKSk7XG5cbiAgICAgICAgY29uc3Qgc2NoZW1hQ2hhaW4gPSBzZm4uQ2hhaW5cbiAgICAgICAgICAgIC5zdGFydChzZXRDcmVhdGVTY2hlbWEpXG4gICAgICAgICAgICAubmV4dChjcmVhdGVTY2hlbWEpXG5cbiAgICAgICAgY29uc3QgZHNDaGFpbiA9IHNmbi5DaGFpblxuICAgICAgICAgICAgLnN0YXJ0KHNldENyZWF0ZURhdGFzZXQpXG4gICAgICAgICAgICAubmV4dChjcmVhdGVEYXRhc2V0KVxuICAgICAgICAgICAgLm5leHQoc2V0RGVzY3JpYmVEYXRhc2V0KVxuICAgICAgICAgICAgLm5leHQod2FpdDVTZWNvbmRzKVxuICAgICAgICAgICAgLm5leHQoZGVzY3JpYmVEYXRhc2V0U3RhdHVzKVxuICAgICAgICAgICAgLm5leHQoaXNDb21wbGV0ZVxuICAgICAgICAgICAgICAgIC53aGVuKHNmbi5Db25kaXRpb24uc3RyaW5nRXF1YWxzKCckLnN0YXR1cycsICdDUkVBVEUgUEVORElORycpLCBzZXREZXNjcmliZURhdGFzZXQpXG4gICAgICAgICAgICAgICAgLndoZW4oc2ZuLkNvbmRpdGlvbi5zdHJpbmdFcXVhbHMoJyQuc3RhdHVzJywgJ0NSRUFURSBJTl9QUk9HUkVTUycpLCBzZXREZXNjcmliZURhdGFzZXQpXG4gICAgICAgICAgICAgICAgLndoZW4oc2ZuLkNvbmRpdGlvbi5zdHJpbmdFcXVhbHMoJyQuc3RhdHVzJywgJ0NSRUFURSBGQUlMRUQnKSwgZmFpbClcbiAgICAgICAgICAgICAgICAud2hlbihzZm4uQ29uZGl0aW9uLnN0cmluZ0VxdWFscygnJC5zdGF0dXMnLCAnQUNUSVZFJyksIHNldENyZWF0ZURhdGFzZXRJbXBvcnRKb2IpKVxuICAgICAgICAgICAgLm5leHQoc2V0Q3JlYXRlRGF0YXNldEltcG9ydEpvYilcbiAgICAgICAgICAgIC5uZXh0KGNyZWF0ZURhdGFzZXRJbXBvcnRKb2IpXG4gICAgICAgICAgICAubmV4dChzZXREZXNjcmliZURhdGFzZXRJbXBvcnRKb2IpXG4gICAgICAgICAgICAubmV4dCh3YWl0MzBTZWNvbmRzKVxuICAgICAgICAgICAgLm5leHQoZGVzY3JpYmVEYXRhc2V0SW1wb3J0Sm9iKVxuICAgICAgICAgICAgLm5leHQoaXNDb21wbGV0ZVxuICAgICAgICAgICAgICAgIC53aGVuKHNmbi5Db25kaXRpb24uc3RyaW5nRXF1YWxzKCckLnN0YXR1cycsICdDUkVBVEUgUEVORElORycpLCBzZXREZXNjcmliZURhdGFzZXRJbXBvcnRKb2IpXG4gICAgICAgICAgICAgICAgLndoZW4oc2ZuLkNvbmRpdGlvbi5zdHJpbmdFcXVhbHMoJyQuc3RhdHVzJywgJ0NSRUFURSBJTl9QUk9HUkVTUycpLCBzZXREZXNjcmliZURhdGFzZXRJbXBvcnRKb2IpXG4gICAgICAgICAgICAgICAgLndoZW4oc2ZuLkNvbmRpdGlvbi5zdHJpbmdFcXVhbHMoJyQuc3RhdHVzJywgJ0NSRUFURSBGQUlMRUQnKSwgZmFpbClcbiAgICAgICAgICAgICAgICAud2hlbihzZm4uQ29uZGl0aW9uLnN0cmluZ0VxdWFscygnJC5zdGF0dXMnLCAnQUNUSVZFJyksIHN1Y2Nlc3MpKTtcblxuICAgICAgICBuZXcgc2ZuLlN0YXRlTWFjaGluZSh0aGlzLCAnQ3JlYXRlIFBlcnNvbmFsaXplIERhdGFzZXQgR3JvdXAnLCB7XG4gICAgICAgICAgICBkZWZpbml0aW9uOiBkc2dDaGFpblxuICAgICAgICB9KTtcblxuICAgICAgICBuZXcgc2ZuLlN0YXRlTWFjaGluZSh0aGlzLCAnQ3JlYXRlIFBlcnNvbmFsaXplIFNjaGVtYScsIHtcbiAgICAgICAgICAgIGRlZmluaXRpb246IHNjaGVtYUNoYWluXG4gICAgICAgIH0pO1xuXG4gICAgICAgIG5ldyBzZm4uU3RhdGVNYWNoaW5lKHRoaXMsICdDcmVhdGUgUGVyc29uYWxpemUgRGF0YXNldCcsIHtcbiAgICAgICAgICAgIGRlZmluaXRpb246IGRzQ2hhaW5cbiAgICAgICAgfSk7XG4gICAgfVxufVxuXG5jb25zdCBhcHAgPSBuZXcgY2RrLkFwcCgpO1xubmV3IFBlcnNvbmFsaXplTWFuYWdlbWVudFN0YWNrKGFwcCwgJ3BlcnNvbmFsaXplLW1hbmFnZW1lbnQtYXBwJyk7XG5hcHAuc3ludGgoKTtcbiJdfQ==